# アーキテクチャドキュメント

AI チャットボット「Yumi」のシステムアーキテクチャ概要。

## 目次

- [システム概要](#システム概要)
- [技術スタック](#技術スタック)
- [アーキテクチャ図](#アーキテクチャ図)
- [ディレクトリ構成](#ディレクトリ構成)
- [コンポーネント詳細](#コンポーネント詳細)
- [データフロー](#データフロー)
- [セキュリティ](#セキュリティ)

---

## システム概要

Yumi はエンターテイメント向けの AI チャットボットアプリケーションです。
ユーザーは Web ブラウザからキャラクター「Yumi」との会話を楽しめます。

### 主な特徴

- リアルタイムチャット（非ストリーミング）
- セッションベースの会話管理
- ブラウザを閉じると会話履歴リセット
- レスポンシブデザイン（PC・モバイル対応）

---

## 技術スタック

```
┌─────────────────────────────────────────────────────────────┐
│                      Frontend                                │
├─────────────────────────────────────────────────────────────┤
│  Next.js (App Router)  │  React 19  │  Tailwind CSS         │
│  TypeScript            │  react-window (仮想化)              │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      Backend (API)                           │
├─────────────────────────────────────────────────────────────┤
│  Hono (Web Framework)  │  Mastra (AI Agent)                 │
│  Prisma (ORM)          │  CORS / CSRF / Rate Limiting       │
└─────────────────────────────────────────────────────────────┘
                              │
              ┌───────────────┴───────────────┐
              ▼                               ▼
┌─────────────────────────┐     ┌─────────────────────────────┐
│       MongoDB           │     │      Claude API             │
│   (会話履歴永続化)       │     │   (AI 応答生成)             │
└─────────────────────────┘     └─────────────────────────────┘
```

| レイヤー | 技術 | 用途 |
|---------|------|------|
| フロントエンド | Next.js 15 (App Router) | SSR、ルーティング |
| | React 19 | UIコンポーネント |
| | Tailwind CSS | スタイリング |
| | react-window | メッセージリスト仮想化 |
| バックエンド | Hono | 軽量Web Framework |
| | Mastra | AIエージェント管理 |
| | Prisma | MongoDB ORM |
| AI | Claude API (Anthropic) | 応答生成 |
| データベース | MongoDB | 会話履歴永続化 |
| インフラ | Docker / Cloud Run | コンテナデプロイ |

---

## アーキテクチャ図

### 全体構成

```
┌──────────────────────────────────────────────────────────────────────────┐
│                              Client (Browser)                             │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │                         React Application                          │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────────┐ │  │
│  │  │ ChatContainer│  │ MessageList  │  │     InputForm            │ │  │
│  │  │              │  │ (Virtualized)│  │                          │ │  │
│  │  └──────┬───────┘  └──────────────┘  └──────────────────────────┘ │  │
│  │         │                                                          │  │
│  │  ┌──────┴───────┐  ┌──────────────┐                               │  │
│  │  │ useSession   │  │ useMessages  │  ← Custom Hooks               │  │
│  │  │ (UUID管理)   │  │ (状態管理)   │                               │  │
│  │  └──────────────┘  └──────────────┘                               │  │
│  │         │                  │                                       │  │
│  │         └────────┬─────────┘                                       │  │
│  │                  ▼                                                 │  │
│  │         ┌──────────────┐                                          │  │
│  │         │sessionStorage│  ← ブラウザストレージ                     │  │
│  │         └──────────────┘                                          │  │
│  └────────────────────────────────────────────────────────────────────┘  │
│                                    │                                      │
│                                    │ HTTP (fetch)                         │
└────────────────────────────────────┼──────────────────────────────────────┘
                                     │
                                     ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                           Next.js Server                                  │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │                    API Routes (/api/[...route])                    │  │
│  │  ┌──────────────────────────────────────────────────────────────┐ │  │
│  │  │                      Hono Application                        │ │  │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌─────────────┐  │ │  │
│  │  │  │   CORS   │→ │   CSRF   │→ │Rate Limit│→ │   Handler   │  │ │  │
│  │  │  │Middleware│  │Middleware│  │Middleware│  │             │  │ │  │
│  │  │  └──────────┘  └──────────┘  └──────────┘  └──────┬──────┘  │ │  │
│  │  │                                                    │         │ │  │
│  │  │  Endpoints:                                        │         │ │  │
│  │  │  - POST /api/chat                                  │         │ │  │
│  │  │  - GET  /api/chat/:sessionId                       │         │ │  │
│  │  │  - DELETE /api/session/:sessionId                  │         │ │  │
│  │  │  - GET  /api/health                                │         │ │  │
│  │  └────────────────────────────────────────────────────┼─────────┘ │  │
│  └───────────────────────────────────────────────────────┼───────────┘  │
│                                                          │               │
│                    ┌─────────────────────────────────────┼───────────┐  │
│                    │              Libraries              │           │  │
│                    │  ┌──────────────┐  ┌───────────────┴────────┐  │  │
│                    │  │    Prisma    │  │       Mastra           │  │  │
│                    │  │   (ORM)      │  │    (AI Agent)          │  │  │
│                    │  └──────┬───────┘  └───────────┬────────────┘  │  │
│                    └─────────┼──────────────────────┼───────────────┘  │
└──────────────────────────────┼──────────────────────┼───────────────────┘
                               │                      │
                               ▼                      ▼
                    ┌──────────────────┐   ┌──────────────────────┐
                    │     MongoDB      │   │    Claude API        │
                    │  ┌────────────┐  │   │   (Anthropic)        │
                    │  │  Message   │  │   │                      │
                    │  │  Session   │  │   │  Model: claude-sonnet-4-20250514│
                    │  └────────────┘  │   │                      │
                    └──────────────────┘   └──────────────────────┘
```

### コンポーネント階層

```
App (layout.tsx)
└── Page (page.tsx)
    └── ChatContainer
        ├── Header
        │   └── [ロゴ, タイトル]
        ├── ErrorMessage (条件付き表示)
        ├── VirtualizedMessageList
        │   └── MessageBubble (複数)
        │       ├── [アバター画像] (Yumi のみ)
        │       └── [メッセージ本文]
        ├── LoadingIndicator (条件付き表示)
        └── InputForm
            ├── [テキストエリア]
            └── [送信ボタン]
```

---

## ディレクトリ構成

```
ai-chat/
├── src/
│   ├── app/                      # Next.js App Router
│   │   ├── api/
│   │   │   └── [...route]/
│   │   │       └── route.ts      # Hono へのルーティング
│   │   ├── globals.css           # グローバルスタイル
│   │   ├── layout.tsx            # ルートレイアウト
│   │   └── page.tsx              # メインページ
│   │
│   ├── components/               # React コンポーネント
│   │   ├── Chat/
│   │   │   ├── ChatContainer.tsx # チャット全体のコンテナ
│   │   │   ├── Header.tsx        # ヘッダー
│   │   │   ├── InputForm.tsx     # 入力フォーム
│   │   │   ├── MessageBubble.tsx # メッセージ吹き出し
│   │   │   ├── MessageList.tsx   # メッセージリスト
│   │   │   └── VirtualizedMessageList.tsx # 仮想化リスト
│   │   └── ui/
│   │       ├── ErrorMessage.tsx  # エラー表示
│   │       └── LoadingIndicator.tsx # ローディング表示
│   │
│   ├── hooks/                    # カスタムフック
│   │   ├── useMessages.ts        # メッセージ状態管理
│   │   └── useSession.ts         # セッション管理
│   │
│   ├── lib/                      # ライブラリ・ユーティリティ
│   │   ├── errors.ts             # エラー分類
│   │   ├── hono/
│   │   │   ├── app.ts            # Hono アプリケーション
│   │   │   └── rate-limit.ts     # レート制限ミドルウェア
│   │   ├── mastra/
│   │   │   ├── agent.ts          # Yumi エージェント定義
│   │   │   └── index.ts          # Mastra エクスポート
│   │   └── prisma/
│   │       └── client.ts         # Prisma クライアント
│   │
│   ├── types/                    # 型定義
│   │   └── index.ts
│   │
│   └── __tests__/                # テストファイル
│       └── components/
│
├── prisma/
│   └── schema.prisma             # データベーススキーマ
│
├── public/
│   └── avatar.jpg                # Yumi アバター画像
│
├── docs/                         # ドキュメント
│   ├── API.md
│   ├── ARCHITECTURE.md
│   └── SETUP.md
│
├── e2e/                          # E2E テスト
│
├── Dockerfile                    # Docker 設定
├── docker-compose.yml            # Docker Compose 設定
└── package.json
```

---

## コンポーネント詳細

### フロントエンド

#### ChatContainer

チャット機能全体を管理するメインコンポーネント。

**責務:**
- メッセージの送受信
- ローディング・エラー状態の管理
- セッション管理フックとの連携

**使用フック:**
- `useSession()`: セッションID管理
- `useMessages(sessionId)`: メッセージ状態管理

#### VirtualizedMessageList

react-window を使用した仮想化メッセージリスト。

**責務:**
- 大量メッセージの効率的レンダリング
- 自動スクロール
- 高さの動的計算

#### Custom Hooks

| フック | 責務 |
|--------|------|
| `useSession` | セッションIDの生成・取得・無効化 |
| `useMessages` | メッセージのCRUD、sessionStorage同期 |

### バックエンド

#### Hono Application

軽量で高速なWebフレームワーク。Next.js API Routes と統合。

**ミドルウェアスタック:**
1. CORS - クロスオリジン制御
2. CSRF - CSRF保護（本番のみ）
3. Rate Limiter - レート制限

#### Mastra Agent (Yumi)

AI エージェントフレームワーク。Claude API との連携を抽象化。

**設定:**
- Model: `anthropic/claude-sonnet-4-20250514`
- System Prompt: Yumiのキャラクター設定

#### Prisma Client

MongoDB へのアクセスを提供するORM。

**モデル:**
- `Message`: チャットメッセージ
- `Session`: セッション情報（有効期限付き）

---

## データフロー

### メッセージ送信フロー

```
┌─────────────────────────────────────────────────────────────────────────┐
│ 1. ユーザーがメッセージを入力して送信                                    │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ 2. InputForm が onSendMessage を呼び出し                                │
│    - 入力値のバリデーション（空白、長さ）                                │
│    - 送信中状態の設定                                                   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ 3. ChatContainer が handleSendMessage を実行                            │
│    - ユーザーメッセージを addMessage で追加                              │
│    - sessionStorage に保存                                              │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ 4. fetch で POST /api/chat を呼び出し                                   │
│    - タイムアウト: 30秒                                                 │
│    - Body: { message, sessionId }                                       │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ 5. Hono ミドルウェアチェーン                                            │
│    CORS → CSRF → Rate Limit → Handler                                  │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ 6. Handler がリクエストを処理                                           │
│    - バリデーション（sessionId形式、メッセージ長）                       │
│    - Session を upsert                                                  │
│    - ユーザーメッセージを DB に保存                                      │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ 7. Mastra Agent (Yumi) が応答を生成                                     │
│    - Claude API にリクエスト                                            │
│    - キャラクター設定に基づいた応答                                      │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ 8. 応答を DB に保存してレスポンス返却                                    │
│    - assistant メッセージを保存                                         │
│    - { response, sessionId } を返却                                     │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ 9. ChatContainer が応答を処理                                           │
│    - assistant メッセージを addMessage で追加                           │
│    - ローディング状態を解除                                             │
│    - エラーがあればエラー状態を設定                                      │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ 10. VirtualizedMessageList が再レンダリング                             │
│     - 新しいメッセージを表示                                            │
│     - 自動スクロール                                                    │
└─────────────────────────────────────────────────────────────────────────┘
```

### セッション管理フロー

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         ブラウザ起動時                                   │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │ useSession フック                                                  │ │
│  │   1. sessionStorage から ID を取得                                 │ │
│  │   2. 存在しない場合 → crypto.randomUUID() で生成                   │ │
│  │   3. sessionStorage に保存                                         │ │
│  └───────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         メッセージ送信時                                 │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │ サーバー側                                                         │ │
│  │   1. Session を upsert（新規作成 or 有効期限更新）                  │ │
│  │   2. expiresAt = 現在時刻 + 24時間                                 │ │
│  └───────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         ブラウザを閉じた時                               │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │ 1. sessionStorage がクリアされる                                   │ │
│  │ 2. 次回アクセス時に新しい sessionId が生成される                   │ │
│  │ 3. サーバー側の古いセッションは 24 時間後に期限切れ                 │ │
│  └───────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## セキュリティ

### 実装済みセキュリティ対策

| 対策 | 実装 | 説明 |
|------|------|------|
| CORS | Hono middleware | 許可オリジンのみアクセス許可 |
| CSRF | Hono middleware | Origin ヘッダー検証（本番のみ） |
| Rate Limit | カスタムミドルウェア | IPベース、1分20リクエスト |
| 入力バリデーション | Handler | メッセージ長、sessionId形式 |
| セキュリティヘッダー | next.config.ts | X-Frame-Options, CSP 等 |
| セッション有効期限 | Prisma | 24時間で自動失効 |

### セキュリティヘッダー

```
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
X-XSS-Protection: 1; mode=block
Referrer-Policy: strict-origin-when-cross-origin
Content-Security-Policy: default-src 'self'; ...
```

---

## 関連ドキュメント

- [API リファレンス](./API.md)
- [セットアップガイド](./SETUP.md)
